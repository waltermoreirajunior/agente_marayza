<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Atendimento Virtual - Marayza Pires Pilates e Fisioterapia</title>

  <!-- React / ReactDOM (UMD) -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Babel standalone para JSX no browser -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind via CDN (r√°pido para prot√≥tipo) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <meta property="og:title" content="Atendimento Virtual - Marayza Pires Pilates e Fisioterapia" />
  <meta property="og:description" content="Chat online para agendamentos e informa√ß√µes" />
  <meta property="og:image" content="URL_DA_SUA_LOGO" />
</head>
<body class="bg-gray-50">
  <div id="root" class="min-h-screen flex items-center justify-center p-6"></div>

  <!--
    C√≥digo embutido com type="text/babel" ‚Äî recomendado para abrir via file://
    Se preferir usar arquivo externo, veja a vers√£o chatbot.js abaixo e rode um servidor HTTP.
  -->
  <script type="text/babel">
    // ChatBot embutido ‚Äî usa React global (UMD) sem imports
    const { useState, useEffect, useRef } = React;

    const LEADS_API_URL = "http://localhost:4000/api/leads"; // ajuste caso contr√°rio

    function ChatBot() {
      const [messages, setMessages] = useState([
        {
          id: 1,
          text:
            "Ol√°! Bem-vindo(a) √† Marayza Pires Pilates e Fisioterapia! üòä\n\nPosso ajudar com informa√ß√µes sobre servi√ßos, hor√°rios ou agendamento. Observa√ß√£o: valores s√£o informados pela nossa equipe humana ‚Äî posso anotar seus dados para que a recep√ß√£o entre em contato?",
          isBot: true,
          timestamp: new Date()
        }
      ]);
      const [inputText, setInputText] = useState("");
      const [isTyping, setIsTyping] = useState(false);
      const messagesEndRef = useRef(null);

      // Lead flow
      const [leadFlow, setLeadFlow] = useState(false);
      const [leadStep, setLeadStep] = useState(null);
      const [collectedLead, setCollectedLead] = useState({
        nome: "",
        whatsapp: "",
        servico: "",
        periodo: ""
      });
      const [isSubmitting, setIsSubmitting] = useState(false);

      const services = {
        "fisioterapia ortop√©dica": {
          name: "Fisioterapia Ortop√©dica",
          description:
            "Tratamento especializado para les√µes musculoesquel√©ticas, dores nas costas, articula√ß√µes e reabilita√ß√£o p√≥s-cir√∫rgica.",
          duration: "50 minutos",
          price: "Consulte valores"
        },
        "fisioterapia p√©lvica": {
          name: "Fisioterapia P√©lvica e Obst√©trica",
          description:
            "Especializada em sa√∫de da mulher, prepara√ß√£o para o parto, p√≥s-parto e disfun√ß√µes do assoalho p√©lvico.",
          duration: "50 minutos",
          price: "Consulte valores"
        },
        "laser-terapia": {
          name: "Laser-terapia",
          description:
            "Tratamento com laser para al√≠vio da dor, cicatriza√ß√£o e regenera√ß√£o de tecidos.",
          duration: "30 minutos",
          price: "Consulte valores"
        },
        "pilates solo": {
          name: "Pilates Solo",
          description:
            "Exerc√≠cios de pilates no solo para fortalecimento, flexibilidade e consci√™ncia corporal.",
          duration: "60 minutos",
          price: "Consulte valores"
        },
        "pilates tradicional": {
          name: "Pilates Tradicional",
          description:
            "Pilates com equipamentos tradicionais para reabilita√ß√£o e condicionamento f√≠sico.",
          duration: "50 minutos",
          price: "Consulte valores"
        },
        "pilates acrob√°tico": {
          name: "Pilates Acrob√°tico",
          description:
            "Modalidade avan√ßada que combina pilates com movimentos acrob√°ticos suspensos.",
          duration: "60 minutos",
          price: "Consulte valores"
        }
      };

      useEffect(() => {
        scrollToBottom();
      }, [messages]);

      const scrollToBottom = () => {
        messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
      };

      const addBotMessage = (text) => {
        setMessages((prev) => [
          ...prev,
          { id: prev.length + 1, text, isBot: true, timestamp: new Date() }
        ]);
      };

      const extractPhone = (text) => {
        // extrai sequ√™ncia num√©rica razo√°vel (simples)
        const m = text.replace(/\D+/g, "");
        if (!m) return null;
        // formatar com espa√ßo para leitura (64 9xxxxxxxx)
        return m;
      };

      const startLeadFlow = () => {
        setLeadFlow(true);
        setLeadStep("askName");
        addBotMessage("Perfeito ‚Äî posso anotar seus dados para o agendamento. Qual seu *nome completo*?");
      };

      const handleLeadInput = (text) => {
        if (leadStep === "askName") {
          setCollectedLead((p) => ({ ...p, nome: text }));
          setLeadStep("askWhatsapp");
          addBotMessage("√ìtimo! Qual o seu WhatsApp para contato? (ex.: 64 9 9123-4567)");
          return;
        }
        if (leadStep === "askWhatsapp") {
          const phone = extractPhone(text) || text;
          setCollectedLead((p) => ({ ...p, whatsapp: phone }));
          setLeadStep("askService");
          addBotMessage("Qual servi√ßo deseja agendar? (ex.: Fisioterapia Ortop√©dica, Pilates Solo, Laser-terapia)");
          return;
        }
        if (leadStep === "askService") {
          setCollectedLead((p) => ({ ...p, servico: text }));
          setLeadStep("askPeriod");
          addBotMessage("Qual per√≠odo prefere? (manh√£ / tarde / noite)");
          return;
        }
        if (leadStep === "askPeriod") {
          setCollectedLead((p) => ({ ...p, periodo: text }));
          setLeadStep("confirm");
          const summary = `Confirmando:\n\nNome: ${collectedLead.nome || "[nome]"}\nWhatsApp: ${collectedLead.whatsapp ||
            "[whatsapp]"}\nServi√ßo: ${collectedLead.servico || "[servi√ßo]"}\nPer√≠odo: ${text}\n\nEst√° tudo certo? Responda "sim" para confirmar ou "n√£o" para corrigir.`;
          addBotMessage(summary);
          return;
        }
        if (leadStep === "confirm") {
          const ok = /^(s|sim|ok|certo|ta|t√°)/i.test(text.trim());
          if (ok) {
            submitLead();
          } else {
            // reinicia corre√ß√£o
            setCollectedLead({ nome: "", whatsapp: "", servico: "", periodo: "" });
            setLeadStep("askName");
            addBotMessage("Certo ‚Äî vamos recome√ßar. Qual seu nome completo?");
          }
          return;
        }
      };

      const submitLead = async () => {
        setIsSubmitting(true);
        addBotMessage("Aguarde um instante ‚Äî estou registrando sua solicita√ß√£o e nossa recep√ß√£o confirmar√° pelo WhatsApp em breve. üëç");

        const payload = {
          nome: collectedLead.nome,
          whatsapp: collectedLead.whatsapp,
          servico: collectedLead.servico,
          periodo: collectedLead.periodo,
          origem: "chatbot_web",
          timestamp: new Date().toISOString()
        };

        try {
          // tenta enviar para backend (se houver)
          await fetch(LEADS_API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
          addBotMessage("Lead registrada com sucesso! A recep√ß√£o entrar√° em contato pelo WhatsApp para confirmar o hor√°rio e passar valores.");
        } catch (err) {
          console.warn("Erro ao enviar lead (backend pode n√£o estar rodando):", err);
          addBotMessage("Registro local efetuado no chat. Por favor, entre em contato pelo WhatsApp: (64) 99233-4004 para confirmar o agendamento.");
        } finally {
          setIsSubmitting(false);
          setLeadFlow(false);
          setLeadStep(null);
          setCollectedLead({ nome: "", whatsapp: "", servico: "", periodo: "" });
        }
      };

      const generateBotResponse = (userMessage) => {
        const message = userMessage.toLowerCase();

        // Sauda√ß√µes
        if (/(^|\s)(ol√°|oi|bom dia|boa tarde|boa noite)(\s|!|$)/i.test(message)) {
          return "Ol√°! √â um prazer falar com voc√™! Posso fornecer informa√ß√µes sobre nossos servi√ßos, hor√°rios ou ajudar com agendamentos.";
        }

        // Servi√ßos espec√≠ficos
        for (const [key, service] of Object.entries(services)) {
          if (message.includes(key) || message.includes(key.replace("-", " "))) {
            return `üìç **${service.name}**\n\n${service.description}\n\n‚è∞ Dura√ß√£o: ${service.duration}\nüí∞ Valor: ${service.price}\n\nGostaria de agendar uma consulta ou precisa de mais informa√ß√µes?`;
          }
        }

        // Lista de servi√ßos
        if (message.includes("servi√ßos") || message.includes("tratamentos") || message.includes("o que voc√™s fazem")) {
          return `üè• **Nossos Servi√ßos:**\n\n‚Ä¢ Fisioterapia Ortop√©dica\n‚Ä¢ Fisioterapia P√©lvica e Obst√©trica\n‚Ä¢ Laser-terapia\n‚Ä¢ Pilates Solo\n‚Ä¢ Pilates Tradicional\n‚Ä¢ Pilates Acrob√°tico\n\nSobre qual servi√ßo gostaria de saber mais?`;
        }

        // Agendamento (inicia leadFlow)
        if (message.includes("agendar") || message.includes("marcar") || message.includes("consulta") || message.includes("hor√°rio")) {
          startLeadFlow();
          return null; // startLeadFlow j√° adiciona a mensagem de pergunta
        }

        // Valores/Pre√ßos
        if (message.includes("valor") || message.includes("pre√ßo") || message.includes("quanto custa")) {
          return "üí∞ **Valores**\n\nNossos valores variam conforme o tratamento. A recep√ß√£o informa valores ‚Äî quer que eu registre seu nome e WhatsApp para que entrem em contato?";
        }

        // Hor√°rio de funcionamento
        if (message.includes("hor√°rio") || message.includes("funcionamento") || message.includes("aberto")) {
          return "üïê **Hor√°rio de Funcionamento**\n\n‚Ä¢ Segunda & Quarta: 07:00 - 11:00 / 14:00 - 20:00\n‚Ä¢ Ter√ßa & Quinta: 06:00 - 10:00 / 14:00 - 20:00";
        }

        // Localiza√ß√£o
        if (message.includes("endere√ßo") || message.includes("localiza√ß√£o") || message.includes("onde fica")) {
          return "üìç **Localiza√ß√£o**\n\nAv Geraldo Em√≠dio Carneiro, N¬∫ 1 - Guanabara\nIpameri - Goi√°s\nCEP: 75780-000\n\nCoordenadas: 17¬∞43'16.7\"S 48¬∞09'40.0\"W";
        }

        // Despedida
        if (/(tchau|obrigad[oa])/i.test(message)) {
          return "Foi um prazer ajud√°-lo(a)! üòä Estamos √† disposi√ß√£o. Para emerg√™ncias, ligue: (64) 99233-4004.";
        }

        // Default
        return "Entendi! Posso ajudar com:\n‚Ä¢ Informa√ß√µes sobre servi√ßos\n‚Ä¢ Agendamentos (posso coletar nome e WhatsApp)\n‚Ä¢ Hor√°rios\n‚Ä¢ Localiza√ß√£o\n\nOu voc√™ pode chamar diretamente no WhatsApp: (64) 99233-4004\n\nComo posso ajudar?";
      };

      const handleSendMessage = () => {
        if (!inputText.trim()) return;
        const text = inputText.trim();
        setMessages((prev) => [...prev, { id: prev.length + 1, text, isBot: false, timestamp: new Date() }]);
        setInputText("");
        setIsTyping(true);

        setTimeout(() => {
          if (leadFlow) {
            handleLeadInput(text);
            setIsTyping(false);
            return;
          }

          const botText = generateBotResponse(text);
          if (botText) {
            setMessages((prev) => [...prev, { id: prev.length + 1, text: botText, isBot: true, timestamp: new Date() }]);
          }
          setIsTyping(false);
        }, 700);
      };

      const handleKeyPress = (e) => {
        if (e.key === "Enter") handleSendMessage();
      };

      const formatTime = (date) => {
        return new Date(date).toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit" });
      };

      const QuickButtons = () => {
        const quickOptions = ["Ver servi√ßos", "Agendar consulta", "Hor√°rio de funcionamento", "Localiza√ß√£o"];
        return (
          <div className="flex flex-wrap gap-2 p-4 bg-gray-50">
            {quickOptions.map((option, idx) => (
              <button
                key={idx}
                onClick={() => {
                  if (option === "Agendar consulta") {
                    setTimeout(() => {
                      setInputText("agendar");
                      handleSendMessage();
                    }, 100);
                    return;
                  }
                  setInputText(option.toLowerCase());
                  setTimeout(() => handleSendMessage(), 100);
                }}
                className="px-3 py-2 bg-blue-100 text-blue-700 rounded-full text-sm hover:bg-blue-200 transition-colors"
              >
                {option}
              </button>
            ))}
          </div>
        );
      };

      return (
        <div className="max-w-4xl mx-auto bg-white rounded-lg shadow-lg overflow-hidden w-full">
          {/* Header */}
          <div className="bg-gradient-to-r from-blue-600 to-blue-800 text-white p-4">
            <div className="flex items-center gap-3">
              <div className="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                <span className="text-2xl">ü§ñ</span>
              </div>
              <div>
                <h1 className="text-xl font-bold">Assistente Virtual</h1>
                <p className="text-blue-100">Marayza Pires Pilates e Fisioterapia</p>
              </div>
            </div>
          </div>

          {/* Quick Info */}
          <div className="bg-blue-50 p-4 border-b">
            <div className="flex flex-wrap gap-6 text-sm text-blue-800">
              <div className="flex items-center gap-2">
                <span>‚è∞</span>
                <span>Seg & Qua: 07h‚Äì11h / 14h‚Äì20h ‚Ä¢ Ter & Qui: 06h‚Äì10h / 14h‚Äì20h</span>
              </div>
              <div className="flex items-center gap-2">
                <span>üìû</span>
                <span>(64) 99233-4004 (WhatsApp)</span>
              </div>
              <div className="flex items-center gap-2">
                <span>üìÖ</span>
                <span>Agendamento preferencial por WhatsApp</span>
              </div>
            </div>
          </div>

          {/* Messages */}
          <div className="h-96 overflow-y-auto p-4 space-y-4">
            {messages.map((message) => (
              <div key={message.id} className={`flex gap-3 ${message.isBot ? "justify-start" : "justify-end"}`}>
                {message.isBot && (
                  <div className="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center flex-shrink-0">
                    <span className="text-white">ü§ñ</span>
                  </div>
                )}

                <div className={`max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${message.isBot ? "bg-gray-100 text-gray-800" : "bg-blue-600 text-white"}`}>
                  <div className="whitespace-pre-wrap">{message.text}</div>
                  <div className={`text-xs mt-1 ${message.isBot ? "text-gray-500" : "text-blue-100"}`}>{formatTime(message.timestamp)}</div>
                </div>

                {!message.isBot && (
                  <div className="w-8 h-8 bg-green-600 rounded-full flex items-center justify-center flex-shrink-0">
                    <span className="text-white">üë§</span>
                  </div>
                )}
              </div>
            ))}

            {isTyping && (
              <div className="flex gap-3 justify-start">
                <div className="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center flex-shrink-0">
                  <span className="text-white">ü§ñ</span>
                </div>
                <div className="bg-gray-100 px-4 py-2 rounded-lg">
                  <div className="flex space-x-1">
                    <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                    <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: "0.1s" }}></div>
                    <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: "0.2s" }}></div>
                  </div>
                </div>
              </div>
            )}

            <div ref={messagesEndRef} />
          </div>

          {/* Quick Buttons */}
          <QuickButtons />

          {/* Input */}
          <div className="border-t p-4">
            <div className="flex gap-2">
              <input
                type="text"
                value={inputText}
                onChange={(e) => setInputText(e.target.value)}
                onKeyPress={handleKeyPress}
                placeholder="Digite sua mensagem..."
                className="flex-1 px-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500"
                disabled={isSubmitting}
              />
              <button
                onClick={handleSendMessage}
                disabled={!inputText.trim() || isSubmitting}
                className="px-6 py-2 bg-blue-600 text-white rounded-full hover:bg-blue-700 disabled:bg-gray-400 transition-colors flex items-center gap-2"
              >
                <span>üì©</span>
                <span>Enviar</span>
              </button>
            </div>
            <p className="text-xs text-gray-500 mt-2 text-center">Para emerg√™ncias, ligue diretamente: (64) 99233-4004</p>
          </div>
        </div>
      );
    }

    // render
    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(React.createElement(ChatBot));
  </script>
</body>
</html>
