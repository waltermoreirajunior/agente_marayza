<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Atendimento Virtual - Marayza Pires Pilates e Fisioterapia</title>

  <!-- React / ReactDOM (UMD) -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Babel standalone para JSX no browser -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind via CDN (rÃ¡pido para protÃ³tipo) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <meta property="og:title" content="Atendimento Virtual - Marayza Pires Pilates e Fisioterapia" />
  <meta property="og:description" content="Chat online para agendamentos e informaÃ§Ãµes" />
  <meta property="og:image" content="URL_DA_SUA_LOGO" />
</head>
<body class="bg-gray-50">
  <div id="root" class="min-h-screen flex items-center justify-center p-6"></div>

  <!--
    CÃ³digo embutido com type="text/babel" â€” recomendado para abrir via file://
    Se preferir usar arquivo externo, veja a versÃ£o chatbot.js abaixo e rode um servidor HTTP.
  -->
  <script type="text/babel">
    // ChatBot embutido â€” usa React global (UMD) sem imports
    const { useState, useEffect, useRef } = React;

    const LEADS_API_URL = "http://localhost:4000/api/leads"; // ajuste caso contrÃ¡rio

    function ChatBot() {
      const [messages, setMessages] = useState([
        {
          id: 1,
          text:
            "OlÃ¡! Bem-vindo(a) Ã  Marayza Pires Pilates e Fisioterapia! ğŸ˜Š\n\nPosso ajudar com informaÃ§Ãµes sobre serviÃ§os, horÃ¡rios ou agendamento. ObservaÃ§Ã£o: valores sÃ£o informados pela nossa equipe humana â€” posso anotar seus dados para que a recepÃ§Ã£o entre em contato?",
          isBot: true,
          timestamp: new Date()
        }
      ]);
      const [inputText, setInputText] = useState("");
      const [isTyping, setIsTyping] = useState(false);
      const messagesEndRef = useRef(null);

      // Lead flow
      const [leadFlow, setLeadFlow] = useState(false);
      const [leadStep, setLeadStep] = useState(null);
      const [collectedLead, setCollectedLead] = useState({
        nome: "",
        whatsapp: "",
        servico: "",
        periodo: ""
      });
      const [isSubmitting, setIsSubmitting] = useState(false);

      const services = {
        "fisioterapia ortopÃ©dica": {
          name: "Fisioterapia OrtopÃ©dica",
          description:
            "Tratamento especializado para lesÃµes musculoesquelÃ©ticas, dores nas costas, articulaÃ§Ãµes e reabilitaÃ§Ã£o pÃ³s-cirÃºrgica.",
          duration: "50 minutos",
          price: "Consulte valores"
        },
        "fisioterapia pÃ©lvica": {
          name: "Fisioterapia PÃ©lvica e ObstÃ©trica",
          description:
            "Especializada em saÃºde da mulher, preparaÃ§Ã£o para o parto, pÃ³s-parto e disfunÃ§Ãµes do assoalho pÃ©lvico.",
          duration: "50 minutos",
          price: "Consulte valores"
        },
        "laser-terapia": {
          name: "Laser-terapia",
          description:
            "Tratamento com laser para alÃ­vio da dor, cicatrizaÃ§Ã£o e regeneraÃ§Ã£o de tecidos.",
          duration: "30 minutos",
          price: "Consulte valores"
        },
        "pilates solo": {
          name: "Pilates Solo",
          description:
            "ExercÃ­cios de pilates no solo para fortalecimento, flexibilidade e consciÃªncia corporal.",
          duration: "60 minutos",
          price: "Consulte valores"
        },
        "pilates tradicional": {
          name: "Pilates Tradicional",
          description:
            "Pilates com equipamentos tradicionais para reabilitaÃ§Ã£o e condicionamento fÃ­sico.",
          duration: "50 minutos",
          price: "Consulte valores"
        },
        "pilates acrobÃ¡tico": {
          name: "Pilates AcrobÃ¡tico",
          description:
            "Modalidade avanÃ§ada que combina pilates com movimentos acrobÃ¡ticos suspensos.",
          duration: "60 minutos",
          price: "Consulte valores"
        }
      };

      useEffect(() => {
        scrollToBottom();
      }, [messages]);

      const scrollToBottom = () => {
        messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
      };

      const addBotMessage = (text) => {
        setMessages((prev) => [
          ...prev,
          { id: prev.length + 1, text, isBot: true, timestamp: new Date() }
        ]);
      };

      const extractPhone = (text) => {
        // extrai sequÃªncia numÃ©rica razoÃ¡vel (simples)
        const m = text.replace(/\D+/g, "");
        if (!m) return null;
        // formatar com espaÃ§o para leitura (64 9xxxxxxxx)
        return m;
      };

      const startLeadFlow = () => {
        setLeadFlow(true);
        setLeadStep("askName");
        addBotMessage("Perfeito â€” posso anotar seus dados para o agendamento. Qual seu *nome completo*?");
      };

      const handleLeadInput = (text) => {
        if (leadStep === "askName") {
          setCollectedLead((p) => ({ ...p, nome: text }));
          setLeadStep("askWhatsapp");
          addBotMessage("Ã“timo! Qual o seu WhatsApp para contato? (ex.: 64 9 9123-4567)");
          return;
        }
        if (leadStep === "askWhatsapp") {
          const phone = extractPhone(text) || text;
          setCollectedLead((p) => ({ ...p, whatsapp: phone }));
          setLeadStep("askService");
          addBotMessage("Qual serviÃ§o deseja agendar? (ex.: Fisioterapia OrtopÃ©dica, Pilates Solo, Laser-terapia)");
          return;
        }
        if (leadStep === "askService") {
          setCollectedLead((p) => ({ ...p, servico: text }));
          setLeadStep("askPeriod");
          addBotMessage("Qual perÃ­odo prefere? (manhÃ£ / tarde / noite)");
          return;
        }
        if (leadStep === "askPeriod") {
          setCollectedLead((p) => ({ ...p, periodo: text }));
          setLeadStep("confirm");
          const summary = `Confirmando:\n\nNome: ${collectedLead.nome || "[nome]"}\nWhatsApp: ${collectedLead.whatsapp ||
            "[whatsapp]"}\nServiÃ§o: ${collectedLead.servico || "[serviÃ§o]"}\nPerÃ­odo: ${text}\n\nEstÃ¡ tudo certo? Responda "sim" para confirmar ou "nÃ£o" para corrigir.`;
          addBotMessage(summary);
          return;
        }
        if (leadStep === "confirm") {
          const ok = /^(s|sim|ok|certo|ta|tÃ¡)/i.test(text.trim());
          if (ok) {
            submitLead();
          } else {
            // reinicia correÃ§Ã£o
            setCollectedLead({ nome: "", whatsapp: "", servico: "", periodo: "" });
            setLeadStep("askName");
            addBotMessage("Certo â€” vamos recomeÃ§ar. Qual seu nome completo?");
          }
          return;
        }
      };

      const submitLead = async () => {
        setIsSubmitting(true);
        addBotMessage("Aguarde um instante â€” estou registrando sua solicitaÃ§Ã£o e nossa recepÃ§Ã£o confirmarÃ¡ pelo WhatsApp em breve. ğŸ‘");

        const payload = {
          nome: collectedLead.nome,
          whatsapp: collectedLead.whatsapp,
          servico: collectedLead.servico,
          periodo: collectedLead.periodo,
          origem: "chatbot_web",
          timestamp: new Date().toISOString()
        };

        try {
          // tenta enviar para backend (se houver)
          await fetch(LEADS_API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
          addBotMessage("Lead registrada com sucesso! A recepÃ§Ã£o entrarÃ¡ em contato pelo WhatsApp para confirmar o horÃ¡rio e passar valores.");
        } catch (err) {
          console.warn("Erro ao enviar lead (backend pode nÃ£o estar rodando):", err);
          addBotMessage("Registro local efetuado no chat. Por favor, entre em contato pelo WhatsApp: (64) 99233-4004 para confirmar o agendamento.");
        } finally {
          setIsSubmitting(false);
          setLeadFlow(false);
          setLeadStep(null);
          setCollectedLead({ nome: "", whatsapp: "", servico: "", periodo: "" });
        }
      };

      const generateBotResponse = (userMessage) => {
        const message = userMessage.toLowerCase();

        // SaudaÃ§Ãµes
        if (/(^|\s)(olÃ¡|oi|bom dia|boa tarde|boa noite)(\s|!|$)/i.test(message)) {
          return "OlÃ¡! Ã‰ um prazer falar com vocÃª! Posso fornecer informaÃ§Ãµes sobre nossos serviÃ§os, horÃ¡rios ou ajudar com agendamentos.";
        }

        // ServiÃ§os especÃ­ficos
        for (const [key, service] of Object.entries(services)) {
          if (message.includes(key) || message.includes(key.replace("-", " "))) {
            return `ğŸ“ **${service.name}**\n\n${service.description}\n\nâ° DuraÃ§Ã£o: ${service.duration}\nğŸ’° Valor: ${service.price}\n\nGostaria de agendar uma consulta ou precisa de mais informaÃ§Ãµes?`;
          }
        }

        // Lista de serviÃ§os
        if (message.includes("serviÃ§os") || message.includes("tratamentos") || message.includes("o que vocÃªs fazem")) {
          return `ğŸ¥ **Nossos ServiÃ§os:**\n\nâ€¢ Fisioterapia OrtopÃ©dica\nâ€¢ Fisioterapia PÃ©lvica e ObstÃ©trica\nâ€¢ Laser-terapia\nâ€¢ Pilates Solo\nâ€¢ Pilates Tradicional\nâ€¢ Pilates AcrobÃ¡tico\n\nSobre qual serviÃ§o gostaria de saber mais?`;
        }

        // Agendamento (inicia leadFlow)
        if (message.includes("agendar") || message.includes("marcar") || message.includes("consulta") || message.includes("horÃ¡rio")) {
          startLeadFlow();
          return null; // startLeadFlow jÃ¡ adiciona a mensagem de pergunta
        }

        // Valores/PreÃ§os
        if (message.includes("valor") || message.includes("preÃ§o") || message.includes("quanto custa")) {
          return "ğŸ’° **Valores**\n\nNossos valores variam conforme o tratamento. A recepÃ§Ã£o informa valores â€” quer que eu registre seu nome e WhatsApp para que entrem em contato?";
        }

        // HorÃ¡rio de funcionamento
        if (message.includes("horÃ¡rio") || message.includes("funcionamento") || message.includes("aberto")) {
          return "ğŸ• **HorÃ¡rio de Funcionamento**\n\nâ€¢ Segunda & Quarta: 07:00 - 11:00 / 14:00 - 20:00\nâ€¢ TerÃ§a & Quinta: 06:00 - 10:00 / 14:00 - 20:00";
        }

        // LocalizaÃ§Ã£o
        if (message.includes("endereÃ§o") || message.includes("localizaÃ§Ã£o") || message.includes("onde fica")) {
          return "ğŸ“ **LocalizaÃ§Ã£o**\n\nAv Geraldo EmÃ­dio Carneiro, NÂº 1 - Guanabara\nIpameri - GoiÃ¡s\nCEP: 75780-000\n\nCoordenadas: 17Â°43'16.7\"S 48Â°09'40.0\"W";
        }

        // Despedida
        if (/(tchau|obrigad[oa])/i.test(message)) {
          return "Foi um prazer ajudÃ¡-lo(a)! ğŸ˜Š Estamos Ã  disposiÃ§Ã£o. Para emergÃªncias, ligue: (64) 99233-4004.";
        }

        // Default
        return "Entendi! Posso ajudar com:\nâ€¢ InformaÃ§Ãµes sobre serviÃ§os\nâ€¢ Agendamentos (posso coletar nome e WhatsApp)\nâ€¢ HorÃ¡rios\nâ€¢ LocalizaÃ§Ã£o\n\nOu vocÃª pode chamar diretamente no WhatsApp: (64) 99233-4004\n\nComo posso ajudar?";
      };

      const handleSendMessage = () => {
        if (!inputText.trim()) return;
        const text = inputText.trim();
        setMessages((prev) => [...prev, { id: prev.length + 1, text, isBot: false, timestamp: new Date() }]);
        setInputText("");
        setIsTyping(true);

        setTimeout(() => {
          if (leadFlow) {
            handleLeadInput(text);
            setIsTyping(false);
            return;
          }

          const botText = generateBotResponse(text);
          if (botText) {
            setMessages((prev) => [...prev, { id: prev.length + 1, text: botText, isBot: true, timestamp: new Date() }]);
          }
          setIsTyping(false);
        }, 700);
      };

      const handleKeyPress = (e) => {
        if (e.key === "Enter") handleSendMessage();
      };

      const formatTime = (date) => {
        return new Date(date).toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit" });
      };

      const QuickButtons = () => {
        const quickOptions = ["Ver serviÃ§os", "Agendar consulta", "HorÃ¡rio de funcionamento", "LocalizaÃ§Ã£o"];
        return (
          <div className="flex flex-wrap gap-2 p-4 bg-gray-50">
            {quickOptions.map((option, idx) => (
              <button
                key={idx}
                onClick={() => {
                  if (option === "Agendar consulta") {
                    setTimeout(() => {
                      setInputText("agendar");
                      handleSendMessage();
                    }, 100);
                    return;
                  }
                  setInputText(option.toLowerCase());
                  setTimeout(() => handleSendMessage(), 100);
                }}
                className="px-3 py-2 bg-blue-100 text-blue-700 rounded-full text-sm hover:bg-blue-200 transition-colors"
              >
                {option}
              </button>
            ))}
          </div>
        );
      };

      return (
        <div className="max-w-4xl mx-auto bg-white rounded-lg shadow-lg overflow-hidden w-full">
          {/* Header */}
          <div className="bg-gradient-to-r from-blue-600 to-blue-800 text-white p-4">
            <div className="flex items-center gap-3">
              <div className="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                <span className="text-2xl">ğŸ¤–</span>
              </div>
              <div>
                <h1 className="text-xl font-bold">Assistente Virtual</h1>
                <p className="text-blue-100">Marayza Pires Pilates e Fisioterapia</p>
              </div>
            </div>
          </div>

          {/* Quick Info */}
          <div className="bg-blue-50 p-4 border-b">
            <div className="flex flex-wrap gap-6 text-sm text-blue-800">
              <div className="flex items-center gap-2">
                <span>â°</span>
                <span>Seg & Qua: 07hâ€“11h / 14hâ€“20h â€¢ Ter & Qui: 06hâ€“10h / 14hâ€“20h</span>
              </div>
              <div className="flex items-center gap-2">
                <span>ğŸ“</span>
                <span>(64) 99233-4004 (WhatsApp)</span>
              </div>
              <div className="flex items-center gap-2">
                <span>ğŸ“…</span>
                <span>Agendamento preferencial por WhatsApp</span>
              </div>
            </div>
          </div>

          {/* Messages */}
          <div className="h-96 overflow-y-auto p-4 space-y-4">
            {messages.map((message) => (
              <div key={message.id} className={`flex gap-3 ${message.isBot ? "justify-start" : "justify-end"}`}>
                {message.isBot && (
                  <div className="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center flex-shrink-0">
                    <span className="text-white">ğŸ¤–</span>
                  </div>
                )}

                <div className={`max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${message.isBot ? "bg-gray-100 text-gray-800" : "bg-blue-600 text-white"}`}>
                  <div className="whitespace-pre-wrap">{message.text}</div>
                  <div className={`text-xs mt-1 ${message.isBot ? "text-gray-500" : "text-blue-100"}`}>{formatTime(message.timestamp)}</div>
                </div>

                {!message.isBot && (
                  <div className="w-8 h-8 bg-green-600 rounded-full flex items-center justify-center flex-shrink-0">
                    <span className="text-white">ğŸ‘¤</span>
                  </div>
                )}
              </div>
            ))}

            {isTyping && (
              <div className="flex gap-3 justify-start">
                <div className="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center flex-shrink-0">
                  <span className="text-white">ğŸ¤–</span>
                </div>
                <div className="bg-gray-100 px-4 py-2 rounded-lg">
                  <div className="flex space-x-1">
                    <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                    <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: "0.1s" }}></div>
                    <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: "0.2s" }}></div>
                  </div>
                </div>
              </div>
            )}

            <div ref={messagesEndRef} />
          </div>

          {/* Quick Buttons */}
          <QuickButtons />

          {/* Input */}
          <div className="border-t p-4">
            <div className="flex gap-2">
              <input
                type="text"
                value={inputText}
                onChange={(e) => setInputText(e.target.value)}
                onKeyPress={handleKeyPress}
                placeholder="Digite sua mensagem..."
                className="flex-1 px-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500"
                disabled={isSubmitting}
              />
              <button
                onClick={handleSendMessage}
                disabled={!inputText.trim() || isSubmitting}
                className="px-6 py-2 bg-blue-600 text-white rounded-full hover:bg-blue-700 disabled:bg-gray-400 transition-colors flex items-center gap-2"
              >
                <span>ğŸ“©</span>
                <span>Enviar</span>
              </button>
            </div>
            <p className="text-xs text-gray-500 mt-2 text-center">Para emergÃªncias, ligue diretamente: (64) 99233-4004</p>
          </div>
        </div>
      );
    }

    // render
    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(React.createElement(ChatBot));
  </script>
</body>
</html>
